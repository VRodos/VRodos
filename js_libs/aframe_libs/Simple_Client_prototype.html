<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Take part</title>
    <meta name="description" content="Take part">
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.min.js"></script>
    <script src="js/datgui/0.7.9/dat.gui.min.js"></script>

    <script src="../easyrtc/easyrtc.js"></script>
    <script src="../dist/networked-aframe.js"></script>
    <script src="../js/NoSleep.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/adv-screen.css" />
</head>

<body style="background: gray" id="simple-client-body">
<div id="renderFeedback" class="renderFeedback">
    <div class="renderFeedbackText" id="renderFeedbackText">Waiting for the rendered scene ...</div>
</div>
<div class="actionsActor" name="actionsDiv" id="actionsDiv">
    <div id="reporting"></div>
</div>

<!--
    ENABLED CAMERA & MIC
    video: true; audio: true;
    Make sure your browser allows permissions!
-->
<a-scene
        id="aframe-scene-container"
        background="color: black"
        vr-mode-ui="enabled: false"
        networked-scene="
        app: appname;
        room: roomname;
        debug: true;
        adapter: easyrtc;
        audio: true;
        video: true;
        connectOnLoad: true;
        serverURL: /;
    ">

    <a-assets>
        <!-- Avatar Template -->
        <template id="avatar-template">
            <a-entity class="avatar"
                      networked-audio-source>

                <!-- This plane shows the video stream -->
                <a-plane id="videoPlane"
                         color="#FFF"
                         width="1"
                         height="0.75"
                         position="0 0.6 0.5" material="side: double"
                         networked-video-source="streamName:video">
                </a-plane>

                <a-plane id="screenPlane"
                         color="#FFF"
                         width="8"
                         height="6"
                         position="0 0.6 0" material="side: double; shader:flat"
                         networked-video-source="streamName:screen">
                </a-plane>

            </a-entity>
        </template>
    </a-assets>


    <!-- Local Player -->
    <!-- attachTemplateToLocal:false means you won't see your own face on screen, which is normal -->
    <a-entity id="player"
              networked="template:#avatar-template;attachTemplateToLocal:false;"
              position="0 0 0"
              wasd-controls="fly:true"
              look-controls>

        <a-entity
                active="true"
                camera="near: 0.1; far: 7000.0;"
                position="0 0 0">
        </a-entity>

    </a-entity>

    <!-- Fixed Light -->
    <a-entity
            light="color: #ffaaff; intensity: 1.5"
            position="5 5 5">
    </a-entity>

</a-scene>

<script>
    /* Syncing avatar */
    NAF.schemas.add({
        template: '#avatar-template',
        components: [
            'position',
            'rotation'
        ]
    });

    document.body.addEventListener('connected', onConnect);

    /* Called by Networked-Aframe when connected to server */
    function onConnect () {
        console.log("Connected to NAF Server");

        // Attempt to get user name
        let userName = "User";
        if(window.NAF.entities && window.NAF.entities.entities) {
            userName = Object.keys(window.NAF.entities.entities)[0] || "User";
        }
        let room = window.NAF.room;

        function selectString(room, userName, lang, key, position){
            let str = "Error unknown string";
            switch (key) {
                case "_connected":
                    str = "You are now connected to server at room: " + room;
                    break;
                case "_selectPosition":
                    str = "Select a position in the scene: ";
                    break;
                case "_position":
                    str = "Position: " + position;
                    break;
            }
            return userName + ", " + str;
        }

        let userLang = navigator.language.substring(0,2);
        let reportingEl = document.getElementById("reporting");

        if(reportingEl) {
            reportingEl.innerText = selectString(room, userName, userLang, "_connected");
            setTimeout(function (){
                reportingEl.innerText = selectString(room, userName, userLang, "_selectPosition");
            }, 5000);
        }

        // Hide 3D scene canvas
        let scene = document.getElementsByTagName('a-scene')[0];
        if(scene) scene.style.display='none';
    }

    // Add to a div the input stream of the rendered screen
    function scanForStreamsAndShowInFullScreen(){
        if(!window.NAF || !window.NAF.entities) return;

        for (let e in window.NAF.entities.entities) {
            let entity = window.NAF.entities.entities[e];
            if(!entity.children) continue;

            for (let i=0; i < entity.children.length; i++) {
                let child = entity.children[i];
                if(child.components && child.components['networked-video-source']){
                    let nvs = child.components['networked-video-source'];

                    if(nvs !== undefined){
                        if(nvs.videoTexture !== undefined && nvs.videoTexture !== null) {
                            if (nvs.el.id === 'screenPlane'){
                                let feedbackDiv = document.getElementById("renderFeedback");
                                if(feedbackDiv && feedbackDiv.children.length === 1) {
                                    feedbackDiv.appendChild(nvs.videoTexture.image);
                                    let img = feedbackDiv.children[1];
                                    img.style.position="absolute";
                                    img.style.left="0";
                                    img.style.width = "100%";
                                    document.getElementById("renderFeedbackText").style.visibility = "hidden";
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    let timerForScreenFeedback = setInterval(scanForStreamsAndShowInFullScreen, 3000);

    // Initialize NoSleep
    let noSleep = new NoSleep();

    function go_full_screen(){
        // Enable NoSleep on user click
        noSleep.enable();

        var elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
        } else if (elem.mozRequestFullScreen) {
            elem.mozRequestFullScreen();
        } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
        }
        document.getElementById("view-fullscreen").style.display = "none";
    }

</script>

<button id="view-fullscreen" style="z-index:10000000;position:absolute;right:0;top:0"
        onClick="go_full_screen();">Fullscreen</button>

</body>
</html>